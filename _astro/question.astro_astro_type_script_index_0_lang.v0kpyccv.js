const B={"۰":"0","۱":"1","۲":"2","۳":"3","۴":"4","۵":"5","۶":"6","۷":"7","۸":"8","۹":"9","٠":"0","١":"1","٢":"2","٣":"3","٤":"4","٥":"5","٦":"6","٧":"7","٨":"8","٩":"9"};function T(n){return n?n.replace(/[۰-۹٠-٩]/g,e=>B[e]||e):""}function E(n){return(n||"").replace(/\D+/g,"")}function w(n){return(n||"").replace(/[\s\u00A0\u200C\u200D\u200E\u200F\u061C]+/g,"")}function D(n){const e=E(T(n||""));if(/^09\d{9}$/.test(e))return"98"+e.slice(1);let i=w(T(n||""));return i=i.replace(/^(?:\+?98|0098)\s*/,""),i=E(i),/^9\d{9}$/.test(i)?"98"+i:""}function k(n){let e=w(T(n||""));e=e.replace(/^(?:\+?98|0098)\s*/,"0"),/^9\d{0,10}$/.test(e)&&(e="0"+e),e=E(e),e.length>11&&(e=e.slice(0,11));const i=/^09[0-9]{9}$/.test(e);return{value:e,isValid:i}}function x(n){let e=(n||"").trim();e.startsWith("@")&&(e=e.slice(1)),e=e.replace(/[^\w]/g,"");const i=e.length>=5&&e.length<=32;return{value:e,isValid:i,url:e?"https://t.me/"+e:""}}let I=!1,d=null;const H=800;function L(){I=!0,d&&clearTimeout(d),d=setTimeout(()=>{I=!1,d=null},H)}function S(){const n=document.getElementById("askForm");if(!(n instanceof HTMLFormElement))return;const e=document.getElementById("feedback");if(!(e instanceof HTMLElement))return;const i=n.querySelector('button[type="submit"]');if(!(i instanceof HTMLButtonElement))return;const s=document.getElementById("mobile"),M=document.getElementById("name"),l=document.getElementById("email"),F=document.getElementById("message"),h=n.querySelector("#page_url"),p=n.querySelector("#whatsapp_url"),g=n.querySelector("#telegram_url");h&&(h.value=location.href);function v(t,a=!0){e.textContent=t,e.className="mt-3 text-sm "+(a?"text-green-400":"text-red-400")}const u={required:"این فیلد را پر کنید.",mobileFormat:"شماره موبایل باید 11 رقم و با 09 شروع شود.",needOne:"حداقل یکی از واتساپ یا تلگرام را وارد کنید.",tgFormat:"آیدی تلگرام را به شکل صحیح وارد کنید. مثلا @username",generalFail:"ارسال انجام نشد. لطفا بعدا دوباره تلاش کنید.",network:"خطای شبکه — اتصال اینترنت یا سرور را بررسی کنید."};function y(t,a){t instanceof HTMLElement&&(t.addEventListener("invalid",c=>{const b=a?a(t):u.required;t.setCustomValidity(b),I&&(c.preventDefault(),c.stopImmediatePropagation())}),t.addEventListener("input",()=>{t.setCustomValidity(""),L(),t.value&&!t.checkValidity()?t.classList.add("border-red-500"):t.classList.remove("border-red-500")}),t.addEventListener("blur",()=>{if(t.setCustomValidity(""),!t.checkValidity()){const c=a?a(t):u.required;t.setCustomValidity(c)}}))}if(y(M,()=>u.required),y(F,()=>u.required),s instanceof HTMLInputElement){y(s,()=>u.mobileFormat);const t=()=>{const{value:a,isValid:c}=k(s.value);s.value!==a&&(s.value=a),s.setCustomValidity(""),L(),s.value.length>0&&!c?s.classList.add("border-red-500"):s.classList.remove("border-red-500")};s.addEventListener("input",t),s.addEventListener("blur",t)}if(l instanceof HTMLInputElement){l.removeAttribute("type"),l.setAttribute("type","text"),y(l,()=>u.tgFormat);const t=()=>{const{value:a}=x(l.value);l.value!==a&&"@"+a!==l.value&&(l.value=a?"@"+a:""),l.setCustomValidity(""),L()};l.addEventListener("input",t),l.addEventListener("blur",t)}n.addEventListener("submit",async t=>{t.preventDefault(),d&&(clearTimeout(d),d=null),I=!1;let a=!1,c="";if(s instanceof HTMLInputElement&&s.value){const r=k(s.value);if(s.value=r.value,s.setCustomValidity(""),r.isValid){a=!0;const o=D(r.value);if(o){const f=encodeURIComponent("سلام، درباره سوال مالیاتی پیام دادم.");c="https://wa.me/"+o+"?text="+f}}else a=!1}let b=!1,C="";if(l instanceof HTMLInputElement&&l.value){const r=l.value.startsWith("@")?l.value.slice(1):l.value,o=x(r);o.value&&(b=!0,C=o.url,l.value="@"+o.value)}if(!a&&!b){v(u.needOne,!1),s&&(s.focus(),s.setCustomValidity(u.needOne),s.reportValidity());return}if(!n.checkValidity()){n.reportValidity();return}p&&(p.value=c||""),g&&(g.value=C||"");const V=new FormData(n);h||V.set("page_url",location.href);const q=i.textContent||"ثبت سوال";i.disabled=!0,i.textContent="در حال ثبت...",v("");try{const r=await fetch("https://teloox.ir/forms.php",{method:"POST",body:V});let o=r.ok,f="";if((r.headers.get("content-type")||"").includes("application/json"))try{const m=await r.json();typeof m?.message=="string"&&(f=m.message),typeof m?.success=="boolean"&&(o=o&&m.success),typeof m?.ok=="boolean"&&(o=o&&m.ok)}catch{}else if(!o)try{f=(await r.text()).slice(0,200)}catch{}o?(v(f||"سوال شما با موفقیت ثبت شد.",!0),n.reset(),p&&(p.value=""),g&&(g.value="")):v(f||u.generalFail,!1)}catch{v(u.network,!1)}finally{i.disabled=!1,i.textContent=q}})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",S,{once:!0}):S();
