const P="989124689983",F="zamani_acc",k="سلام، درباره سوالی که در سایت ثبت کردم پیام می دهم.",N={"۰":"0","۱":"1","۲":"2","۳":"3","۴":"4","۵":"5","۶":"6","۷":"7","۸":"8","۹":"9","٠":"0","١":"1","٢":"2","٣":"3","٤":"4","٥":"5","٦":"6","٧":"7","٨":"8","٩":"9"};function B(t){return t?t.replace(/[۰-۹٠-٩]/g,e=>N[e]||e):""}function S(t){return(t||"").replace(/\D+/g,"")}function D(t){return(t||"").replace(/[\س\u00A0\u200C\u200D\u200E\u200F\u061C]+/g,"")}function W(t){const e=S(B(t||""));if(/^09\d{9}$/.test(e))return"98"+e.slice(1);let s=D(B(t||""));return s=s.replace(/^(?:\+?98|0098)\s*/,""),s=S(s),/^9\d{9}$/.test(s)?"98"+s:""}function H(t){let e=D(B(t||""));e=e.replace(/^(?:\+?98|0098)\s*/,"0"),/^9\d{0,10}$/.test(e)&&(e="0"+e),e=S(e),e.length>11&&(e=e.slice(0,11));const s=/^09[0-9]{9}$/.test(e);return{value:e,isValid:s}}function M(t){let e=(t||"").trim();e.startsWith("@")&&(e=e.slice(1)),e=e.replace(/[^\w]/g,"");const s=e.length>=5&&e.length<=32;return{value:e,isValid:s,url:e?"https://t.me/"+e:""}}let E=!1,m=null;const z=800;function x(){E=!0,m&&clearTimeout(m),m=setTimeout(()=>{E=!1,m=null},z)}function O(t,e){const s=document.createElement("a");return s.href=t,s.target="_blank",s.rel="noopener",s.className="inline-block text-center bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded",s.textContent=e,s}function A(){const t=document.getElementById("askForm");if(!(t instanceof HTMLFormElement))return;const e=document.getElementById("feedback"),s=t.querySelector('button[type="submit"]'),a=document.getElementById("mobile"),q=document.getElementById("name"),i=document.getElementById("email"),R=document.getElementById("message"),C=t.querySelector("#page_url"),y=t.querySelector("#whatsapp_url"),v=t.querySelector("#telegram_url");C&&(C.value=location.href),document.getElementById("postSubmitCtas");const b=document.getElementById("ctaButtons"),h=document.getElementById("tgFallback"),I=document.getElementById("copyHelloBtn"),w=document.getElementById("tgWebLink");function g(n,o=!0){e&&(e.textContent=n,e.className="mt-3 text-sm "+(o?"text-green-400":"text-red-400"))}const d={required:"این فیلد را پر کنید.",mobileFormat:"شماره موبایل باید 11 رقم و با 09 شروع شود.",needOne:"حداقل یکی از واتساپ یا تلگرام را وارد کنید.",tgFormat:"آیدی تلگرام را به شکل صحیح وارد کنید. مثلا @username",generalFail:"ارسال انجام نشد. لطفا بعدا دوباره تلاش کنید.",network:"خطای شبکه — اتصال اینترنت یا سرور را بررسی کنید."};function L(n,o){n instanceof HTMLElement&&(n.addEventListener("invalid",u=>{const f=o?o(n):d.required;n.setCustomValidity(f),E&&(u.preventDefault(),u.stopImmediatePropagation())}),n.addEventListener("input",()=>{n.setCustomValidity(""),x(),n.value&&!n.checkValidity()?n.classList.add("border-red-500"):n.classList.remove("border-red-500")}),n.addEventListener("blur",()=>{if(n.setCustomValidity(""),!n.checkValidity()){const u=o?o(n):d.required;n.setCustomValidity(u)}}))}if(L(q,()=>d.required),L(R,()=>d.required),a instanceof HTMLInputElement){L(a,()=>d.mobileFormat);const n=()=>{const{value:o,isValid:u}=H(a.value);a.value!==o&&(a.value=o),a.setCustomValidity(""),x(),a.value.length>0&&!u?a.classList.add("border-red-500"):a.classList.remove("border-red-500")};a.addEventListener("input",n),a.addEventListener("blur",n)}if(i instanceof HTMLInputElement){i.removeAttribute("type"),i.setAttribute("type","text"),L(i,()=>d.tgFormat);const n=()=>{const{value:o}=M(i.value);i.value!==o&&"@"+o!==i.value&&(i.value=o?"@"+o:""),i.setCustomValidity(""),x()};i.addEventListener("input",n),i.addEventListener("blur",n)}t.addEventListener("submit",async n=>{n.preventDefault(),m&&(clearTimeout(m),m=null),E=!1;let o=!1,u="";if(a instanceof HTMLInputElement&&a.value){const c=H(a.value);if(a.value=c.value,a.setCustomValidity(""),c.isValid){o=!0;const l=W(c.value);if(l){const p=encodeURIComponent("سلام، درباره سوال مالیاتی پیام دادم.");u="https://wa.me/"+l+"?text="+p}}}let f=!1,V="";if(i instanceof HTMLInputElement&&i.value){const c=i.value.startsWith("@")?i.value.slice(1):i.value,l=M(c);l.value&&(f=!0,V=l.url,i.value="@"+l.value)}if(!o&&!f){g(d.needOne,!1),a&&(a.focus(),a.setCustomValidity(d.needOne),a.reportValidity());return}if(!t.checkValidity()){t.reportValidity();return}y&&(y.value=u||""),v&&(v.value=V||"");const _=new FormData(t);C||_.set("page_url",location.href);const U=s.textContent||"ثبت سوال";s.disabled=!0,s.textContent="در حال ثبت...",g("");try{const c=await fetch("https://agentbot.zamani.tax/forms.php",{method:"POST",body:_});let l=c.ok,p="";if((c.headers.get("content-type")||"").includes("application/json"))try{const r=await c.json();typeof r?.message=="string"&&(p=r.message),typeof r?.success=="boolean"&&(l=l&&r.success),typeof r?.ok=="boolean"&&(l=l&&r.ok)}catch{}else if(!l)try{p=(await c.text()).slice(0,200)}catch{}if(l){if(g(p||"سوال شما با موفقیت ثبت شد.",!0),t.reset(),y&&(y.value=""),v&&(v.value=""),b&&(b.innerHTML=""),h&&h.classList.add("hidden"),o){const T="https://wa.me/"+P+"?text="+encodeURIComponent(k);b.appendChild(O(T,"شروع گفتگو در واتساپ"))}if(f){const T="tg://resolve?domain="+F+"&text="+encodeURIComponent(k);b.appendChild(O(T,"شروع گفتگو در تلگرام")),h&&w&&I&&(w.href="https://t.me/"+F,h.classList.remove("hidden"),I.onclick=async()=>{try{await navigator.clipboard.writeText(k),I.textContent="کپی شد!",setTimeout(()=>I.textContent="کپی سلام",1500)}catch{}})}const r=document.getElementById("postSubmitCtas");r&&(o||f)?r.classList.remove("hidden"):r&&r.classList.add("hidden")}else{g(p||d.generalFail,!1);const r=document.getElementById("postSubmitCtas");r&&r.classList.add("hidden")}}catch{g(d.network,!1);const l=document.getElementById("postSubmitCtas");l&&l.classList.add("hidden")}finally{s.disabled=!1,s.textContent=U}})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",A,{once:!0}):A();
